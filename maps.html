<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>All Maps we track</title>
<link rel="icon" type="image/png" href="/home/image1.png?v=2" sizes="32x32">
<link rel="shortcut icon" href="/home/image1.png?v=2">
<link rel="apple-touch-icon" href="/home/image1.png?v=2">
<style>
  :root{
    --bg:#0f1220; --panel:#161a2b; --accent:#7bdcff; --muted:#9aa4bf; --text:#e9efff; --border:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box; margin:0; padding:0;}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.4;}
  header{position:sticky; top:0; z-index:2; background:linear-gradient(180deg,rgba(15,18,32,.95),rgba(15,18,32,.70)); backdrop-filter:blur(6px); border-bottom:1px solid var(--border)}
  .container{max-width:1200px; margin:0 auto; padding:16px}
  h1{margin:0; font-size:clamp(22px,3vw,32px)}
  .sub-lg{font-size:clamp(16px,2.2vw,20px); margin-top:6px}
  .sub-sm{color:var(--muted); font-size:13px; margin-top:6px}
  .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px}
  .btn{padding:10px 12px; border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:10px; cursor:pointer; font-size:14px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center}
  .btn:hover{border-color:#2a3150}
  .select,.input{padding:10px 12px; border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:10px; font-size:14px;}
  .grid{margin:16px auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; overflow:visible}
  .grid-scroll{width:100%; overflow:auto; border-radius:16px}
  table{width:100%; border-collapse:collapse}
  thead th{position:relative; text-align:left; padding:12px; font-size:14px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,rgba(22,26,43,.5),rgba(22,26,43,0))}
  tbody td{padding:12px; border-bottom:1px solid var(--border); vertical-align:top}
  tbody tr:hover{background:rgba(255,255,255,.02)}
  .muted{color:var(--muted)}
  a.link{color:var(--accent); text-decoration:none}
  a.link:hover{text-decoration:underline}
  .pill{font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:rgba(255,255,255,.04); display:inline-inline; white-space:nowrap}
  .thumb{width:56px; height:56px; object-fit:cover; border-radius:10px; border:1px solid var(--border); background:#0b0e1a}
  .wrap{white-space:normal; word-break:break-word}
  .status-chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none}
  .dot{width:12px; height:12px; border-radius:50%}
  .dot.green{background:#3ad07a}
  .dot.yellow{background:#ffd66b}
  .dot.red{background:#ff7b7b}

  /* Modal */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:10000}
  .modal{width:min(720px,92vw); background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.4); overflow:hidden}
  .modal header{position:relative; background:linear-gradient(180deg,rgba(22,26,43,.7),rgba(22,26,43,.4)); border-bottom:1px solid var(--border)}
  .modal h3{font-size:18px}
  .modal .content{padding:12px 16px 16px}
  .close-x{position:absolute; right:10px; top:10px; border:1px solid var(--border); background:transparent; color:var(--text); border-radius:8px; padding:4px 8px; cursor:pointer}

  /* Mobile tweaks */
  @media (max-width: 720px){
    .container{padding:12px}
    thead th, tbody td{padding:10px}
    .grid-scroll{overflow-x:auto}
    table{min-width:760px}
  }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>All Maps we track</h1>
    <div class="sub-lg">Below is a list of every Speedrun map/category we track here along with the best times!</div>
    <div class="sub-sm wrap" style="margin-top:8px">
      Some of these maps don't have an official name, so we have named some of these maps ourselves just for the purposes of referencing it on this website, like "Claustrophilia"(ID: Impossible #3) or "Lemon Squeezer" (ID: Medium #2)! If we mistakenly named a map incorrectly which already had a name, please contact Abe (icarus1892) or Oli (interruptingpig) on the ball guys <a class="link" href="https://discord.gg/ballguys" target="_blank" rel="noopener">discord</a> and we will fix it
    </div>

    <div class="toolbar" style="margin-top:12px">
      <a class="btn" href="/home">← Back to Leaderboard</a>
      <span class="muted" id="rowInfo"></span>
      <span class="muted" style="margin-left:auto">Rows per page</span>
      <select id="pageSize" class="select">
        <option>5</option><option selected>10</option><option>25</option><option>50</option><option>100</option>
      </select>
    </div>
  </div>
</header>

<div class="container">
  <div id="errorContainer" style="display:none"></div>

  <div class="grid">
    <div class="grid-scroll">
      <table id="grid">
        <thead>
          <tr>
            <th data-col="thumb">Thumbnail</th>
            <th data-col="author">Map Author</th>
            <th data-col="map">Our Map Name</th>
            <th data-col="best">Best times</th>
            <th data-col="subs">Total submissions</th>
            <th data-col="id">Our Map ID</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="muted" style="text-align:center; padding:40px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="runsModal" class="modal-backdrop">
  <div class="modal">
    <header class="container" style="padding:12px 16px">
      <h3 id="modalTitle">Runs</h3>
      <button class="close-x" id="closeModal">Close</button>
    </header>
    <div class="content">
      <div class="grid">
        <div class="grid-scroll">
          <table id="runsTable">
            <thead>
              <tr>
                <th>Col A</th>
                <th>Col B</th>
                <th>Col C</th>
                <th>Col D</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="muted" style="text-align:center; padding:20px">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Showing first 4 columns from Runs for this map.</div>
    </div>
  </div>
</div>

<script>
/*** CONFIG ***/
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwFY96ZcEnkA7ilt9yaw2XKQZdf92bE-v-kpe8kTe5vG-tgIRB93ecQT5kMFrYc_-6Z2A/exec';

/*** STATE ***/
const state = {
  data: [],
  pageSize: 10,
  page: 1,
  loading: false
};

/*** HELPERS ***/
const $ = s => document.querySelector(s);
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function showError(msg){
  const c = document.getElementById('errorContainer');
  c.innerHTML = `<div class="error" style="background:rgba(255,123,123,.1); border:1px solid rgba(255,123,123,.3); color:#ffc7c7; padding:12px; border-radius:8px; margin:16px 0;">${msg}</div>`;
  c.style.display = 'block';
}
function hideError(){ const c = document.getElementById('errorContainer'); c.style.display='none'; }
function toDrivePreview(url){
  if(!url) return '';
  // Accept sharing links and file links; return direct preview URL if possible
  const m = String(url).match(/[-\w]{25,}/);
  return m ? `https://drive.google.com/uc?export=view&id=${m[0]}` : url;
}
function formatTimeMs(ms){
  ms = Number(ms)||0;
  if(ms<=0) return '0:00.00';
  const total = Math.floor(ms/1000);
  const m = Math.floor(total/60);
  const s = total%60;
  const hth = Math.floor((ms%1000)/10);
  return `${m}:${String(s).padStart(2,'0')}.${String(hth).padStart(2,'0')}`;
}
function parseBest(raw){
  // Expect patterns like "5700 by kayleigh '''" or "0"
  const t = String(raw||'').trim();
  if(t==='0' || t==='') return {label:'No runs posted', level:0, ms:0, user:''};
  const m = t.match(/^(\d+)\s*by\s*(.+?)(\s*'{1,3})?$/i);
  if(!m){ return {label:String(raw), level:0, ms:null, user:''}; }
  const ms = Number(m[1]);
  const user = m[2].trim();
  const ticks = (m[3]||'').replace(/\s+/g,'');
  const level = ticks.length; // 1 green, 2 yellow, 3 red
  return {label:`${formatTimeMs(ms)} by ${user}`, level, ms, user};
}
function levelClass(n){
  if(n>=3) return 'red';
  if(n===2) return 'yellow';
  if(n===1) return 'green';
  return '';
}

/*** DATA IO ***/
async function fetchMaps(){
  if(state.loading) return;
  state.loading = true;
  try{
    hideError();
    const r = await fetch(`${ENDPOINT}?action=maps&_=${Date.now()}`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    if(!Array.isArray(j.rows)) throw new Error('Bad response');
    state.data = j.rows.map(row=>({
      thumb: toDrivePreview(row.thumb),
      author: row.author,
      map: row.map,
      best: row.best,
      subs: row.subs,
      id: row.id
    }));
  }catch(e){
    showError('Failed to load maps: '+e.message);
  }finally{
    state.loading = false;
    render();
  }
}

function paginate(rows){
  const totalPages = Math.max(1, Math.ceil(rows.length / state.pageSize));
  state.page = clamp(state.page, 1, totalPages);
  const start = (state.page-1)*state.pageSize;
  return {pageRows: rows.slice(start, start+state.pageSize), totalPages};
}

/*** RENDER ***/
function render(){
  const tbody = document.querySelector('#grid tbody');
  if(!state.data.length){
    tbody.innerHTML = `<tr><td colspan="6" class="muted" style="text-align:center; padding:40px">No data</td></tr>`;
    return;
  }
  const {pageRows, totalPages} = paginate(state.data);
  let html = '';
  for(const r of pageRows){
    const best = parseBest(r.best);
    html += `
      <tr>
        <td><img class="thumb" src="${r.thumb}" alt="thumb" onerror="this.style.visibility='hidden'"></td>
        <td>${r.author ? r.author : 'Unknown'}</td>
        <td class="wrap">${r.map||''}</td>
        <td>
          ${best.level>0 ? `
            <span class="status-chip" onclick="openRunsModal('${encodeURIComponent(r.map)}')">
              <span class="dot ${levelClass(best.level)}"></span>
              ${best.label.replace(/</g,'&lt;').replace(/>/g,'&gt;')}
            </span>
          ` : `<span class="pill"> ${best.label} </span>`}
        </td>
        <td>${String(r.subs)==='0' ? 'No runs posted' : r.subs}</td>
        <td>${r.id||''}</td>
      </tr>
    `;
  }
  tbody.innerHTML = html;

  const info = document.getElementById('rowInfo');
  info.textContent = `Showing ${pageRows.length} of ${state.data.length}`;

  // simple pager (optional): change page with keyboard arrows
  document.onkeydown = (e)=>{
    if(e.key==='ArrowRight'){ state.page = clamp(state.page+1,1,totalPages); render(); }
    if(e.key==='ArrowLeft'){ state.page = clamp(state.page-1,1,totalPages); render(); }
  }
}

document.getElementById('pageSize').addEventListener('change', ()=>{
  state.pageSize = Number(document.getElementById('pageSize').value)||10;
  state.page = 1;
  render();
});

/*** MODAL FOR RUNS ***/
async function openRunsModal(encodedMap){
  const mapName = decodeURIComponent(encodedMap);
  document.getElementById('modalTitle').textContent = `Runs for: ${mapName}`;
  const modal = document.getElementById('runsModal');
  modal.style.display = 'flex';

  const tbody = document.querySelector('#runsTable tbody');
  tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center; padding:20px">Loading…</td></tr>`;

  try{
    const r = await fetch(`${ENDPOINT}?action=runsForMap&map=${encodeURIComponent(mapName)}&_=${Date.now()}`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    const rows = Array.isArray(j.rows) ? j.rows : [];
    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center; padding:20px">No runs found for this map.</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r=>{
      const cells = r.slice(0,4).map(c=>`<td>${String(c??'')}</td>`).join('');
      return `<tr>${cells}</tr>`;
    }).join('');
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center; padding:20px">Failed to load: ${e.message}</td></tr>`;
  }
}
window.openRunsModal = openRunsModal;
document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('runsModal').style.display='none'; });
document.getElementById('runsModal').addEventListener('click', (e)=>{ if(e.target.id==='runsModal') e.currentTarget.style.display='none'; });

/*** BOOT ***/
document.addEventListener('DOMContentLoaded', ()=>{
  const sel = document.getElementById('pageSize'); sel.value = '10';
  fetchMaps();
});
</script>
</body>
</html>

