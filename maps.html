<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>All Maps we track</title>
<link rel="icon" type="image/png" href="/home/image1.png?v=2" sizes="32x32">
<link rel="shortcut icon" href="/home/image1.png?v=2">
<link rel="apple-touch-icon" href="/home/image1.png?v=2">
<style>
  :root{--bg:#0f1220;--panel:#161a2b;--accent:#7bdcff;--muted:#9aa4bf;--text:#e9efff;--border:rgba(255,255,255,.08);}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.4}
  header{position:sticky;top:0;z-index:2;background:linear-gradient(180deg,rgba(15,18,32,.95),rgba(15,18,32,.70));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:clamp(22px,3vw,32px)}
  .sub-lg{font-size:clamp(16px,2.2vw,20px);margin-top:6px}
  .sub-sm{color:var(--muted);font-size:13px;margin-top:6px}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .btn{padding:10px 12px;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:10px;cursor:pointer;font-size:14px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
  .btn:hover{border-color:#2a3150}
  .select,.input{padding:10px 12px;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:10px;font-size:14px}
  .grid{margin:16px auto;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:visible}
  .grid-scroll{width:100%;overflow:auto;border-radius:16px}
  table{width:100%;border-collapse:collapse}
  thead th{position:relative;text-align:left;padding:12px;font-size:14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(22,26,43,.5),rgba(22,26,43,0))}
  tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
  tbody tr:hover{background:rgba(255,255,255,.02)}
  .muted{color:var(--muted)}
  a.link{color:var(--accent);text-decoration:none}
  a.link:hover{text-decoration:underline}
  .thumb{width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#0b0e1a}
  .wrap{white-space:normal;word-break:break-word}
  .hdr-tools{display:inline-flex;gap:6px;margin-left:6px}
  .hdr-btn{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border:1px solid var(--border);background:var(--panel);border-radius:6px;cursor:pointer;font-size:12px}
  .hdr-btn.sort.active{border-color:rgba(255,214,107,.35);background:rgba(255,214,107,.1)}
  .menu{position:absolute;top:100%;left:0;margin-top:8px;width:min(360px,90vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px;display:none;z-index:1000;max-height:70vh;overflow:auto}
  .menu.open{display:block}
  .pill{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.04);display:inline-block;white-space:nowrap}
  .status-chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer;user-select:none}
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.green{background:#3ad07a}
  .dot.yellow{background:#ffd66b}
  .dot.red{background:#ff7b7b}
  .error{background:rgba(255,123,123,.1);border:1px solid rgba(255,123,123,.3);color:#ffc7c7;padding:12px;border-radius:8px;margin:16px 0}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10000}
  .modal{width:min(720px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);overflow:hidden}
  .modal header{background:linear-gradient(180deg,rgba(22,26,43,.7),rgba(22,26,43,.4));border-bottom:1px solid var(--border)}
  .modal h3{font-size:18px}
  .modal .content{padding:12px 16px 16px}
  .close-x{position:absolute;right:10px;top:10px;border:1px solid var(--border);background:transparent;color:#e9efff;border-radius:8px;padding:4px 8px;cursor:pointer}
  @media (max-width:720px){.container{padding:12px}thead th,tbody td{padding:10px}table{min-width:760px}}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>All Maps we track üó∫Ô∏è</h1>
    <div class="sub-lg">Below is a list of every Speedrun map/category we currently track on our website along with the best times for each!</div>
    <div class="sub-sm wrap" style="margin-top:8px">
      Some of these maps don't have an official name, so we have named some of these maps ourselves just for the purposes of referencing it on this website, like "Claustrophilia"(Impossible #3) or "Lemon Squeezer" (ID: Medium #2)! If we mistakenly named a map incorrectly which already had a name, please contact Abe (icarus1892) or Oli (interruptingpig) on the ball guys <a class="link" href="https://discord.gg/ballguys" target="_blank" rel="noopener">discord</a> and we will fix it
    </div>

    <div class="toolbar">
      <a class="btn" href="/home">‚Üê Back to Leaderboard</a>
      <span class="muted" id="rowInfo"></span>
      <span class="muted" style="margin-left:auto">Rows per page</span>
      <select id="pageSize" class="select">
        <option>5</option><option>10</option><option>25</option><option>50</option><option selected>100</option>
      </select>
    </div>
  </div>
</header>

<div class="container">
  <div id="errorContainer" style="display:none"></div>
  <div class="grid">
    <div class="grid-scroll">
      <table id="grid">
        <thead>
          <tr>
            <th data-col="thumb">Thumbnail</th>
            <th data-col="author">Map Author
              <span class="hdr-tools"><button class="hdr-btn filter">‚è∑</button><button class="hdr-btn sort">‚áÖ</button></span>
              <div class="menu"></div>
            </th>
            <th data-col="map">Our Map Name
              <span class="hdr-tools"><button class="hdr-btn filter">‚è∑</button><button class="hdr-btn sort">‚áÖ</button></span>
              <div class="menu"></div>
            </th>
            <th data-col="best">Best times
              <span class="hdr-tools"><button class="hdr-btn filter">‚è∑</button><button class="hdr-btn sort">‚áÖ</button></span>
              <div class="menu"></div>
            </th>
            <th data-col="subs">Total submissions
              <span class="hdr-tools"><button class="hdr-btn filter">‚è∑</button><button class="hdr-btn sort">‚áÖ</button></span>
              <div class="menu"></div>
            </th>
            <th data-col="id">Our Map ID
              <span class="hdr-tools"><button class="hdr-btn filter">‚è∑</button><button class="hdr-btn sort">‚áÖ</button></span>
              <div class="menu"></div>
            </th>
          </tr>
        </thead>
        <tbody><tr><td colspan="6" class="muted" style="text-align:center;padding:40px">Loading‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div id="runsModal" class="modal-backdrop">
  <div class="modal">
    <header class="container" style="padding:12px 16px">
      <h3 id="modalTitle">Runs</h3>
      <button class="close-x" id="closeModal">Close</button>
    </header>
    <div class="content">
      <div class="grid">
        <div class="grid-scroll">
          <table id="runsTable">
            <thead><tr><th>Nickname</th><th>Time</th><th>Map Name</th><th>Status</th></tr></thead>
            <tbody><tr><td colspan="4" class="muted" style="text-align:center;padding:20px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Above are the top runs for this map</div>
    </div>
  </div>
</div>

<script>
const ENDPOINT='https://script.google.com/macros/s/AKfycbxfbyHMjpva08fMkfmo26JDVtVFE_fbIpkouvB8Bw2YF3QflbiGR4oNdT-CI6Mf6Ug4KA/exec';
const state={data:[],filters:{},sort:{col:'map',dir:'asc'},pageSize:100,page:1,loading:false};
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

function showError(msg){
  let c=$('#errorContainer'); if(!c){c=document.createElement('div');c.id='errorContainer';document.body.appendChild(c);}
  c.innerHTML=`<div class="error">${msg}</div>`; c.style.display='block';
}
function hideError(){const c=$('#errorContainer'); if(c) c.style.display='none';}

function toDriveThumb(u){if(!u)return'';const m=String(u).match(/[-\w]{25,}/);return m?`https://drive.google.com/thumbnail?id=${m[0]}&sz=w120`:u;}
function drivePreviewFallback(img,u){const m=String(u).match(/[-\w]{25,}/); if(m) img.src=`https://drive.google.com/uc?export=view&id=${m[0]}`;}

function formatTime(ms){ms=+ms||0;if(ms<=0)return'0:00.00';const s=Math.floor(ms/1000),m=Math.floor(s/60),r=s%60,h=Math.floor((ms%1000)/10);return`${m}:${String(r).padStart(2,'0')}.${String(h).padStart(2,'0')}`;}
function parseBest(t){t=String(t||'').trim();if(!t||t==='0')return{label:'No runs posted',level:0,ms:0};const m=t.match(/^(\d+)\s*by\s*(.+?)(\s*'{1,3})?$/i);if(!m)return{label:t,level:0};const ms=+m[1],usr=m[2].trim(),lvl=(m[3]||'').replace(/\s+/g,'').length;return{label:`${formatTime(ms)} by ${usr}`,level:lvl,ms,usr};}
function levelClass(n){return n>=3?'red':n===2?'yellow':n===1?'green':'';}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
function uniqueVals(rows,col){return[...new Set(rows.map(r=>String(r[col]??'')))].sort();}

/* FAST PATH: fetch JSON with timeout; FALLBACK: JSONP once if fetch fails */
async function getJSON(params){
  const url=ENDPOINT+'?'+new URLSearchParams({...params,_:Date.now()}).toString();
  // try fetch with 12s timeout
  try{
    const ctlr=new AbortController(); const t=setTimeout(()=>ctlr.abort(),12000);
    const r=await fetch(url,{signal:ctlr.signal,cache:'no-store',credentials:'omit'});
    clearTimeout(t);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(_){
    // fallback JSONP (no retries to keep it snappy)
    return new Promise((resolve,reject)=>{
      const cb='cb_'+Math.random().toString(36).slice(2);
      const s=document.createElement('script');
      const qs=new URLSearchParams({...params,callback:cb,_:Date.now()}).toString();
      let done=false;
      s.src=`${ENDPOINT}?${qs}`;
      window[cb]=(data)=>{ if(done) return; done=true; resolve(data); cleanup(); };
      s.onerror=()=>{ if(done) return; done=true; reject(new Error('Network')); cleanup(); };
      document.body.appendChild(s);
      const tout=setTimeout(()=>{ if(done) return; done=true; reject(new Error('Timeout')); cleanup(); }, 12000);
      function cleanup(){ try{delete window[cb]}catch{}; try{s.remove()}catch{}; clearTimeout(tout); }
    });
  }
}

async function fetchMaps(){
  if(state.loading) return; state.loading=true;
  try{
    hideError();
    const j=await getJSON({action:'maps'});
    if(!j||!Array.isArray(j.rows)) throw new Error('Bad response');
    state.data=j.rows.map(r=>({
      thumb:toDriveThumb(r.thumb), thumbRaw:r.thumb||'',
      author:r.author||'', map:r.map||'', best:r.best||'',
      subs:r.subs||'', id:r.id||''
    }));
    setupHeaders(true); render();
  }catch(e){
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',()=>showError('Failed to load maps: '+e.message),{once:true});
    else showError('Failed to load maps: '+e.message);
  }finally{ state.loading=false; }
}

/*** FILTER + SORT + PAGE ***/
function applyFilters(rows){
  const filters=state.filters;
  return rows.filter(r=>{
    for(const [col,f] of Object.entries(filters)){
      const cell=String(r[col]??'');
      if(f.text && !cell.toLowerCase().includes(f.text.toLowerCase())) return false;
      if(f.selected && f.selected.size>0 && !f.selected.has(cell)) return false;
    }
    return true;
  });
}
function sortRows(rows){
  const {col,dir}=state.sort; const m=dir==='asc'?1:-1;
  return rows.slice().sort((a,b)=>{
    if(col==='best'){
      const pa=parseBest(a.best).ms??Number.MAX_SAFE_INTEGER;
      const pb=parseBest(b.best).ms??Number.MAX_SAFE_INTEGER;
      if(pa!==pb) return (pa-pb)*m;
      return String(a.map).localeCompare(String(b.map),undefined,{numeric:true,sensitivity:'base'})*m;
    }
    const an=Number(a[col]), bn=Number(b[col]);
    if(!Number.isNaN(an) && !Number.isNaN(bn)) return (an-bn)*m;
    return String(a[col]??'').localeCompare(String(b[col]??''),undefined,{numeric:true,sensitivity:'base'})*m;
  });
}
function paginate(rows){
  const totalPages=Math.max(1,Math.ceil(rows.length/state.pageSize));
  state.page=clamp(state.page,1,totalPages);
  const start=(state.page-1)*state.pageSize;
  return {pageRows:rows.slice(start,start+state.pageSize),totalPages,totalRows:rows.length};
}

/*** RENDER + FILTER MENUS ***/
function render(){
  const grid=$('#grid'); if(!grid) return; const tbody=grid.querySelector('tbody'); if(!tbody) return;

  if(!state.data.length){
    tbody.innerHTML=`<tr><td colspan="6" class="muted" style="text-align:center;padding:40px">No data</td></tr>`;
    const info=$('#rowInfo'); if(info) info.textContent='Showing 0 of 0';
    return;
  }

  const filtered=applyFilters(state.data);
  const sorted=sortRows(filtered);
  const {pageRows,totalPages}=paginate(sorted);
  updateSortButtons();

  let html='';
  for(const r of pageRows){
    const b=parseBest(r.best);
    html+=`
      <tr>
        <td>${r.thumb?`<img class="thumb" src="${r.thumb}" loading="lazy" alt="thumb" onerror="drivePreviewFallback(this,'${r.thumbRaw.replace(/'/g,"&#39;")}')">`:''}</td>
        <td>${r.author}</td>
        <td class="wrap">${r.map}</td>
        <td>${
          b.level?`<span class="status-chip" onclick="openRunsModal('${encodeURIComponent(r.map)}')"><span class="dot ${levelClass(b.level)}"></span>${b.label.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`
                 :`<span class="pill">${b.label}</span>`
        }</td>
        <td>${r.subs==='0'?'No runs posted':r.subs}</td>
        <td>${r.id}</td>
      </tr>`;
  }
  tbody.innerHTML=html;

  const info=$('#rowInfo');
  if(info) info.textContent=`Showing ${pageRows.length} of ${filtered.length} rows (${state.data.length} total)`;

  document.onkeydown=(e)=>{ if(e.key==='ArrowRight'){state.page=clamp(state.page+1,1,totalPages);render();} if(e.key==='ArrowLeft'){state.page=clamp(state.page-1,1,totalPages);render();} };
}

function setupHeaders(rebuild=false){
  // init filters (skip thumb)
  ['author','map','best','subs','id'].forEach(k=>{ if(!state.filters[k]) state.filters[k]={text:'',selected:new Set()}; });

  $$('thead th').forEach(th=>{
    const colKey=th.getAttribute('data-col'); if(!colKey || colKey==='thumb') return;
    const fBtn=th.querySelector('.hdr-btn.filter'); const sBtn=th.querySelector('.hdr-btn.sort');
    let menu=th.querySelector('.menu'); if(!menu){menu=document.createElement('div');menu.className='menu';th.appendChild(menu);}
    if(rebuild || !menu.dataset.wired){ buildMenu(menu,colKey); menu.dataset.wired='1'; }
    if(fBtn){ fBtn.onclick=(e)=>{ $$('.menu.open').forEach(m=>m.classList.remove('open')); menu.classList.toggle('open'); e.stopPropagation(); }; }
    if(sBtn){ sBtn.onclick=(e)=>{ state.sort.col===colKey ? state.sort.dir=(state.sort.dir==='asc'?'desc':'asc') : state.sort={col:colKey,dir:'asc'}; state.page=1; render(); e.stopPropagation(); }; }
  });
  document.addEventListener('click',()=> $$('.menu.open').forEach(m=>m.classList.remove('open')));
}
function updateSortButtons(){
  $$('.hdr-btn.sort').forEach(btn=>{
    const th=btn.closest('th'); const col=th.getAttribute('data-col');
    btn.classList.toggle('active', state.sort.col===col);
    btn.textContent = state.sort.col===col ? (state.sort.dir==='asc'?'‚Üë':'‚Üì') : '‚áÖ';
  });
}
function buildMenu(menu,colKey){
  menu.innerHTML='';
  const row1=document.createElement('div'); row1.className='row';
  const input=document.createElement('input'); input.type='text'; input.className='input'; input.placeholder='Search in column...'; input.value=state.filters[colKey].text;
  const clear=document.createElement('button'); clear.className='btn'; clear.textContent='Clear';
  row1.append(input,clear);

  const scroll=document.createElement('div'); scroll.className='scroll';
  const values=uniqueVals(state.data,colKey);
  if(values.length===0){ scroll.innerHTML='<div class="item muted">No values found</div>'; }
  else{
    values.forEach(v=>{
      const label=document.createElement('label'); label.className='item';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=state.filters[colKey].selected.has(String(v));
      const text=document.createElement('span'); text.textContent=(colKey==='best'?parseBest(v).label:(v||'(empty)'));
      label.append(cb,text); scroll.appendChild(label);
      cb.addEventListener('change',()=>{ const set=state.filters[colKey].selected; cb.checked?set.add(String(v)):set.delete(String(v)); });
    });
  }

  const actions=document.createElement('div'); actions.className='actions';
  const apply=document.createElement('button'); apply.className='btn'; apply.textContent='Apply';
  const reset=document.createElement('button'); reset.className='btn'; reset.textContent='Reset';
  actions.append(apply,reset); menu.append(row1,scroll,actions);

  input.addEventListener('input',()=>{ state.filters[colKey].text=input.value; });
  clear.addEventListener('click',()=>{ input.value=''; state.filters[colKey].text=''; });
  apply.addEventListener('click',()=>{ state.page=1; render(); menu.classList.remove('open'); });
  reset.addEventListener('click',()=>{ state.filters[colKey]={text:'',selected:new Set()}; buildMenu(menu,colKey); state.page=1; render(); });
}

/*** CONTROLS ***/
$('#pageSize').addEventListener('change',()=>{ state.pageSize=+$('#pageSize').value||100; state.page=1; render(); });

/*** MODAL ***/
async function openRunsModal(enc){
  const mapName=decodeURIComponent(enc);
  $('#modalTitle').textContent=`Runs for: ${mapName}`;
  const modal=$('#runsModal'); modal.style.display='flex';
  const tbody=$('#runsTable tbody'); tbody.innerHTML='<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">Loading‚Ä¶</td></tr>';
  try{
    const j=await getJSON({action:'runsForMap',map:mapName});
    const rows=Array.isArray(j.rows)?j.rows:[];
    if(!rows.length){tbody.innerHTML='<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">No runs found.</td></tr>'; return;}
    tbody.innerHTML=rows.map(r=>`<tr><td>${r[0]||''}</td><td>${formatTime(r[1])}</td><td>${r[2]||''}</td><td>${r[3]||''}</td></tr>`).join('');
  }catch(e){tbody.innerHTML=`<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">Failed: ${e.message}</td></tr>`;}
}
window.openRunsModal=openRunsModal;
$('#closeModal').onclick=()=>$('#runsModal').style.display='none';
$('#runsModal').onclick=e=>{ if(e.target.id==='runsModal') e.currentTarget.style.display='none'; };

/*** BOOT ***/
document.addEventListener('DOMContentLoaded',()=>{ $('#pageSize').value='100'; fetchMaps(); });
</script>
</body>
</html>
